
> nextn@0.1.0 test
> jest --runInBand --verbose

FAIL src/test/documentation-fetcher-comprehensive.test.ts
  DocumentationFetcher Service
    constructor
      âœ“ should initialize with settings (3 ms)
      âœ“ should initialize with GitHub token (1 ms)
      âœ“ should initialize with LLM config (1 ms)
    fetchLibraryDocumentation
      âœ“ should handle empty library list (1 ms)
      âœ“ should skip invalid libraries (1 ms)
      âœ• should fetch documentation for valid libraries (2 ms)
      âœ“ should use cached documentation when available (1 ms)
      âœ“ should handle errors during documentation fetching (1 ms)
      âœ• should trim documentation if it exceeds size limits (1 ms)
    error handling and edge cases
      âœ“ should handle network timeouts gracefully
      âœ“ should handle malformed library names (1 ms)
      âœ• should handle concurrent library fetching (1 ms)
    settings configuration
      âœ“ should respect includeOfficialDocs setting
      âœ“ should respect maxDocumentationSizeKB setting (1 ms)
      âœ“ should respect preferredSources setting
    utility methods
      âœ“ should handle cache directory creation (1 ms)

  â— DocumentationFetcher Service â€º fetchLibraryDocumentation â€º should fetch documentation for valid libraries

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

    [0m [90m 145 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 146 |[39m
    [31m[1m>[22m[39m[90m 147 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 148 |[39m       expect(result[33m.[39mlibraries[[35m0[39m][33m.[39mname)[33m.[39mtoBe([32m'react'[39m)[33m;[39m
     [90m 149 |[39m       expect(result[33m.[39mfetchedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 150 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBe([35m50[39m)[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:147:32)

  â— DocumentationFetcher Service â€º fetchLibraryDocumentation â€º should trim documentation if it exceeds size limits

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

    [0m [90m 253 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 254 |[39m
    [31m[1m>[22m[39m[90m 255 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 256 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBeLessThan([35m2000[39m)[33m;[39m
     [90m 257 |[39m     })[33m;[39m
     [90m 258 |[39m   })[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:255:32)

  â— DocumentationFetcher Service â€º error handling and edge cases â€º should handle concurrent library fetching

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

    [0m [90m 352 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 353 |[39m
    [31m[1m>[22m[39m[90m 354 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 355 |[39m       expect(result[33m.[39mfetchedCount)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m 356 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBe([35m30[39m)[33m;[39m
     [90m 357 |[39m     })[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:354:32)

FAIL src/test/research-task.test.ts (68.533 s)
  researchTask AI Flow
    basic functionality
      âœ• should research task details and return enhanced task information (11115 ms)
      âœ“ should handle task research for frontend components (2512 ms)
      âœ“ should require model parameter (5 ms)
    error handling
      âœ“ should handle API errors gracefully (1 ms)
      âœ“ should handle empty response (1 ms)
      âœ• should handle malformed response gracefully (7585 ms)
    configuration options
      âœ• should pass configuration options to AI service (7598 ms)
      âœ“ should handle undefined configuration gracefully (7458 ms)
    prompt template
      âœ“ should include all context information in the prompt (7442 ms)
      âœ“ should include required sections in prompt (7379 ms)
      âœ“ should include markdown formatting instructions (7452 ms)
    task enhancement
      âœ“ should preserve content in research output (7372 ms)
      âœ“ should handle tasks with database operations (2493 ms)

  â— researchTask AI Flow â€º basic functionality â€º should research task details and return enhanced task information

    expect(received).toContain(expected) // indexOf

    Expected substring: "Implementation Steps"
    Received string:    "Default research content"

    [0m [90m 79 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m researchTask(input[33m,[39m params[33m.[39mapiKey[33m,[39m params[33m.[39mmodel[33m,[39m params[33m.[39mapiBase)[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Implementation Steps'[39m)[33m;[39m
     [90m    |[39m                                      [31m[1m^[22m[39m
     [90m 82 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Required Libraries'[39m)[33m;[39m
     [90m 83 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Acceptance Criteria'[39m)[33m;[39m
     [90m 84 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'jsonwebtoken'[39m)[33m;[39m[0m

      at Object.toContain (src/test/research-task.test.ts:81:38)

  â— researchTask AI Flow â€º error handling â€º should handle malformed response gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: "Invalid response format without proper structure"
    Received: "Task research content"

    [0m [90m 192 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m researchTask(input[33m,[39m params[33m.[39mapiKey[33m,[39m params[33m.[39mmodel[33m,[39m params[33m.[39mapiBase)[33m;[39m
     [90m 193 |[39m
    [31m[1m>[22m[39m[90m 194 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoBe([32m'Invalid response format without proper structure'[39m)[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 195 |[39m     })[33m;[39m
     [90m 196 |[39m   })[33m;[39m
     [90m 197 |[39m[0m

      at Object.toBe (src/test/research-task.test.ts:194:38)

  â— researchTask AI Flow â€º configuration options â€º should pass configuration options to AI service

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"config": {"apiBase": "https://api.test.com", "apiKey": "test-key", "temperature": 0.8}, "model": "test/model", "prompt": StringContaining "Test task"}
    Received
           1
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },
           2
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },
           3
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },

    Number of calls: 3

    [0m [90m 216 |[39m       [36mawait[39m researchTask(input[33m,[39m apiKey[33m,[39m model[33m,[39m apiBase[33m,[39m temperature)[33m;[39m
     [90m 217 |[39m
    [31m[1m>[22m[39m[90m 218 |[39m       expect(mockAI[33m.[39mgenerate)[33m.[39mtoHaveBeenCalledWith({
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 219 |[39m         model[33m:[39m [32m'test/model'[39m[33m,[39m
     [90m 220 |[39m         prompt[33m:[39m expect[33m.[39mstringContaining([32m'Test task'[39m)[33m,[39m
     [90m 221 |[39m         config[33m:[39m {[0m

      at Object.toHaveBeenCalledWith (src/test/research-task.test.ts:218:31)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: undefined

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: test/model

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

  console.log
    [DEBUG] generateFileStructure called with model: google/gemini-pro

      at console.<anonymous> (node_modules/jest-mock/build/index.js:631:25)

PASS src/test/generate-file-structure.test.ts
  generateFileStructure AI Flow
    basic functionality
      âœ“ should generate file structure from PRD, architecture, and specifications (23 ms)
      âœ“ should handle Python/Flask project structure (2 ms)
      âœ“ should require model parameter (13 ms)
      âœ“ should log debug information (3 ms)
    error handling
      âœ“ should handle API errors gracefully (2 ms)
      âœ“ should handle empty response (2 ms)
      âœ“ should retry on markdown linting failures (3 ms)
      âœ“ should return best available content after max retries (1 ms)
    configuration options
      âœ“ should pass configuration options to AI service (2 ms)
      âœ“ should handle undefined configuration gracefully (2 ms)
    prompt template
      âœ“ should include all input parameters in the prompt (2 ms)
      âœ“ should include instructions for markdown output (1 ms)
    markdown linting integration
      âœ“ should call MarkdownLinter with correct parameters (2 ms)
      âœ“ should return fixed content when linter provides it (2 ms)

  console.error
    Error generating architecture: Error: AI generation failed
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:80:21)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 35 |[39m     [36mreturn[39m result[33m;[39m
     [90m 36 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 37 |[39m     console[33m.[39merror([32m'Error generating architecture:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 38 |[39m     [36mif[39m (
     [90m 39 |[39m       error [36minstanceof[39m [33mError[39m [33m&&[39m
     [90m 40 |[39m       (error[33m.[39mmessage[33m.[39mincludes([32m'API key not found'[39m) [33m||[39m[0m

      at error (src/app/actions.ts:37:13)
      at Object.<anonymous> (src/test/actions.test.ts:84:7)

  console.error
    Error generating architecture: Error: Model is required
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:91:21)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 35 |[39m     [36mreturn[39m result[33m;[39m
     [90m 36 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 37 |[39m     console[33m.[39merror([32m'Error generating architecture:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 38 |[39m     [36mif[39m (
     [90m 39 |[39m       error [36minstanceof[39m [33mError[39m [33m&&[39m
     [90m 40 |[39m       (error[33m.[39mmessage[33m.[39mincludes([32m'API key not found'[39m) [33m||[39m[0m

      at error (src/app/actions.ts:37:13)
      at Object.<anonymous> (src/test/actions.test.ts:95:7)

  console.error
    Error generating tasks: Error: Generation failed
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:166:47)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 65 |[39m     [36mreturn[39m result[33m;[39m
     [90m 66 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 67 |[39m     console[33m.[39merror([32m'Error generating tasks:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 68 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
     [90m 69 |[39m       [32m'Failed to generate tasks. The model may have returned an unexpected response.'[39m
     [90m 70 |[39m     )[33m;[39m[0m

      at error (src/app/actions.ts:67:13)
      at Object.<anonymous> (src/test/actions.test.ts:168:7)

  console.error
    Error generating file structure: Error: Invalid API key
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:213:55)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m  97 |[39m     [36mreturn[39m result[33m;[39m
     [90m  98 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m  99 |[39m     console[33m.[39merror([32m'Error generating file structure:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 100 |[39m     [36mif[39m (
     [90m 101 |[39m       error [36minstanceof[39m [33mError[39m [33m&&[39m
     [90m 102 |[39m       (error[33m.[39mmessage[33m.[39mincludes([32m'API key not found'[39m) [33m||[39m[0m

      at error (src/app/actions.ts:99:13)
      at Object.<anonymous> (src/test/actions.test.ts:215:7)

  console.error
    Error generating file structure: Error: Unknown error
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:227:55)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m  97 |[39m     [36mreturn[39m result[33m;[39m
     [90m  98 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m  99 |[39m     console[33m.[39merror([32m'Error generating file structure:'[39m[33m,[39m error)[33m;[39m
     [90m     |[39m             [31m[1m^[22m[39m
     [90m 100 |[39m     [36mif[39m (
     [90m 101 |[39m       error [36minstanceof[39m [33mError[39m [33m&&[39m
     [90m 102 |[39m       (error[33m.[39mmessage[33m.[39mincludes([32m'API key not found'[39m) [33m||[39m[0m

      at error (src/app/actions.ts:99:13)
      at Object.<anonymous> (src/test/actions.test.ts:229:7)

  console.error
    Error researching task "Test task" (Attempt 1/3): Error: Research failed
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:276:46)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 130 |[39m       [36mreturn[39m result[33m;[39m
     [90m 131 |[39m     } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 132 |[39m       console[33m.[39merror(
     [90m     |[39m               [31m[1m^[22m[39m
     [90m 133 |[39m         [32m`Error researching task "${input.title}" (Attempt ${i + 1}/${MAX_RETRIES}):`[39m[33m,[39m
     [90m 134 |[39m         error
     [90m 135 |[39m       )[33m;[39m[0m

      at error (src/app/actions.ts:132:15)
      at Object.<anonymous> (src/test/actions.test.ts:278:7)

  console.error
    Error generating architecture: Error: Model is required
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:319:56)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 35 |[39m     [36mreturn[39m result[33m;[39m
     [90m 36 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 37 |[39m     console[33m.[39merror([32m'Error generating architecture:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 38 |[39m     [36mif[39m (
     [90m 39 |[39m       error [36minstanceof[39m [33mError[39m [33m&&[39m
     [90m 40 |[39m       (error[33m.[39mmessage[33m.[39mincludes([32m'API key not found'[39m) [33m||[39m[0m

      at error (src/app/actions.ts:37:13)
      at Object.<anonymous> (src/test/actions.test.ts:321:9)

  console.error
    Error generating tasks: Error: Weird internal error
        at Object.<anonymous> (/home/runner/work/gitautomate/gitautomate/src/test/actions.test.ts:327:31)
        at Promise.finally.completed (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1556:28)
        at new Promise (<anonymous>)
        at callAsyncCircusFn (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1496:10)
        at _callCircusTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1006:40)
        at _runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:946:3)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:839:13)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at _runTestsForDescribeBlock (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:829:11)
        at run (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:757:3)
        at runAndTransformResultsToJestFormat (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/jestAdapterInit.js:1917:21)
        at jestAdapter (/home/runner/work/gitautomate/gitautomate/node_modules/jest-circus/build/runner.js:101:19)
        at runTestInternal (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:275:16)
        at runTest (/home/runner/work/gitautomate/gitautomate/node_modules/jest-runner/build/index.js:343:7)

    [0m [90m 65 |[39m     [36mreturn[39m result[33m;[39m
     [90m 66 |[39m   } [36mcatch[39m (error) {
    [31m[1m>[22m[39m[90m 67 |[39m     console[33m.[39merror([32m'Error generating tasks:'[39m[33m,[39m error)[33m;[39m
     [90m    |[39m             [31m[1m^[22m[39m
     [90m 68 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
     [90m 69 |[39m       [32m'Failed to generate tasks. The model may have returned an unexpected response.'[39m
     [90m 70 |[39m     )[33m;[39m[0m

      at error (src/app/actions.ts:67:13)
      at Object.<anonymous> (src/test/actions.test.ts:337:7)

FAIL src/test/actions.test.ts (30.217 s)
  App Actions
    runGenerateArchitecture
      âœ“ should call generateArchitecture with input and options (3 ms)
      âœ“ should handle undefined options (1 ms)
      âœ• should handle errors from generateArchitecture (34 ms)
      âœ• should preserve original error if it contains specific messages (4 ms)
    runGenerateTasks
      âœ“ should validate required input fields (1 ms)
      âœ“ should call generateTasks with all parameters
      âœ“ should handle missing architecture field (1 ms)
      âœ“ should handle errors from generateTasks (2 ms)
    runGenerateFileStructure
      âœ“ should call generateFileStructure with correct parameters (1 ms)
      âœ• should handle API key errors with specific message (4 ms)
      âœ“ should handle general errors (2 ms)
    runResearchTask
      âœ• should call researchTask with correct parameters (1 ms)
      âœ• should handle errors from researchTask (30001 ms)
      âœ• should handle undefined options (2 ms)
    error handling patterns
      âœ• should preserve specific error messages (5 ms)
      âœ“ should provide generic error messages for unexpected errors (3 ms)
    parameter passing
      âœ“ should handle partial options correctly
      âœ“ should handle boolean and number options correctly

  â— App Actions â€º runGenerateArchitecture â€º should handle errors from generateArchitecture

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate architecture. The model may have returned an unexpected response."
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:84:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:84:60)

  â— App Actions â€º runGenerateArchitecture â€º should preserve original error if it contains specific messages

    expect(received).rejects.toThrow(expected)

    Expected substring: "Model is required"
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:95:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:95:60)

  â— App Actions â€º runGenerateFileStructure â€º should handle API key errors with specific message

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate file structure: Your LLM API key is missing or invalid. Please check it in settings."
    Received message:   "File structure generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD, architecture, or specifications."

        [0m [90m 108 |[39m       )[33m;[39m
         [90m 109 |[39m     }
        [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m     |[39m           [31m[1m^[22m[39m
         [90m 111 |[39m       [32m'File structure generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD, architecture, or specifications.'[39m
         [90m 112 |[39m     )[33m;[39m
         [90m 113 |[39m   }[0m

      at runGenerateFileStructure (src/app/actions.ts:110:11)
      at Object.<anonymous> (src/test/actions.test.ts:215:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:215:61)

  â— App Actions â€º runResearchTask â€º should call researchTask with correct parameters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"architecture": "React with JWT", "fileStructure": "src/auth/", "specifications": "Login and registration", "title": "Implement user authentication"},
      "test-key",
      "test/model",
      "https://api.test.com",
    - 0.8,
    + undefined,
    + 0.8,

    Number of calls: 1

    [0m [90m 256 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m runResearchTask(input[33m,[39m options)[33m;[39m
     [90m 257 |[39m
    [31m[1m>[22m[39m[90m 258 |[39m       expect(mockResearchTask)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 259 |[39m         input[33m,[39m
     [90m 260 |[39m         [32m'test-key'[39m[33m,[39m
     [90m 261 |[39m         [32m'test/model'[39m[33m,[39m[0m

      at Object.toHaveBeenCalledWith (src/test/actions.test.ts:258:32)

  â— App Actions â€º runResearchTask â€º should handle errors from researchTask

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

    [0m [90m 266 |[39m     })[33m;[39m
     [90m 267 |[39m
    [31m[1m>[22m[39m[90m 268 |[39m     it([32m'should handle errors from researchTask'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 269 |[39m       [36mconst[39m input [33m=[39m {
     [90m 270 |[39m         title[33m:[39m [32m'Test task'[39m[33m,[39m
     [90m 271 |[39m         architecture[33m:[39m [32m'Test architecture'[39m[33m,[39m[0m

      at it (src/test/actions.test.ts:268:5)
      at describe (src/test/actions.test.ts:235:3)
      at Object.describe (src/test/actions.test.ts:23:1)

  â— App Actions â€º runResearchTask â€º should handle undefined options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"architecture": "Test architecture", "fileStructure": "Test structure", "specifications": "Test specifications", "title": "Test task"},
      undefined,
      undefined,
      undefined,
      undefined,
    + undefined,

    Number of calls: 1

    [0m [90m 297 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m runResearchTask(input)[33m;[39m
     [90m 298 |[39m
    [31m[1m>[22m[39m[90m 299 |[39m       expect(mockResearchTask)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 300 |[39m         input[33m,[39m
     [90m 301 |[39m         undefined[33m,[39m
     [90m 302 |[39m         undefined[33m,[39m[0m

      at Object.toHaveBeenCalledWith (src/test/actions.test.ts:299:32)

  â— App Actions â€º error handling patterns â€º should preserve specific error messages

    expect(received).rejects.toThrow(expected)

    Expected substring: "Model is required"
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:321:9)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:322:20)

PASS src/test/generate-tasks.test.ts
  generateTasks AI Flow
    basic functionality
      âœ“ should generate tasks from architecture, specifications, and file structure (4 ms)
      âœ“ should handle TDD mode with different prompt (1 ms)
      âœ“ should require model parameter (11 ms)
    markdown parsing
      âœ“ should parse bullet points with dash (-) format (2 ms)
      âœ“ should parse bullet points with asterisk (*) format
      âœ“ should handle mixed content with headers and text
      âœ“ should use fallback parsing for action-based lines (1 ms)
    error handling
      âœ“ should handle API errors gracefully (1 ms)
      âœ“ should throw error when no tasks can be extracted (1 ms)
      âœ“ should handle empty response (1 ms)
    configuration options
      âœ“ should pass configuration options to AI service (1 ms)
      âœ“ should handle undefined configuration gracefully (1 ms)
    prompt templates
      âœ“ should use standard prompt when TDD is false (2 ms)
      âœ“ should use TDD prompt when TDD is true (1 ms)

PASS src/test/markdown-comprehensive.test.ts
  Markdown Utilities
    ensureMarkdownStructure
      âœ“ should add title if missing (2 ms)
      âœ“ should not add title if already present (1 ms)
      âœ“ should fix header spacing (1 ms)
      âœ“ should remove excessive blank lines
      âœ“ should end with single newline (1 ms)
      âœ“ should preserve code blocks
      âœ“ should handle empty content (1 ms)
      âœ“ should handle whitespace-only content
    formatTaskMarkdown
      âœ“ should handle proper markdown (1 ms)
      âœ“ should convert ### headers to ## headers when missing standard sections
      âœ“ should preserve well-formatted structure
      âœ“ should handle missing structure gracefully
      âœ“ should trim whitespace (1 ms)
    formatArchitectureMarkdown
      âœ“ should ensure Architecture title
      âœ“ should preserve existing Architecture title (1 ms)
      âœ“ should apply general markdown formatting
    formatSpecificationsMarkdown
      âœ“ should ensure Specifications title
      âœ“ should preserve existing title
    formatFileStructureMarkdown
      âœ“ should ensure File Structure title
      âœ“ should handle code-block style structure (1 ms)
    formatPRDMarkdown
      âœ“ should ensure PRD title
      âœ“ should preserve existing PRD title (1 ms)
    error handling and edge cases
      âœ“ should handle null/undefined input (1 ms)
      âœ“ should handle very long content
      âœ“ should handle special characters
      âœ“ should preserve indentation in code blocks (1 ms)
    complex formatting scenarios
      âœ“ should handle mixed content types (1 ms)
      âœ“ should maintain link formatting

FAIL src/test/generate-architecture.test.ts
  generateArchitecture AI Flow
    basic functionality
      âœ“ should generate architecture and specifications from PRD (3 ms)
      âœ“ should handle PRD with specific technology requirements (1 ms)
      âœ“ should require model parameter (9 ms)
    error handling
      âœ“ should handle API errors gracefully
      âœ“ should handle malformed markdown response
      âœ• should retry on markdown linting failures (3 ms)
    markdown parsing
      âœ“ should parse sections with different header formats (1 ms)
      âœ• should handle fallback parsing when headers are missing (1 ms)
    configuration options
      âœ“ should pass configuration options to AI service (1 ms)
      âœ“ should handle undefined configuration gracefully (1 ms)

  â— generateArchitecture AI Flow â€º error handling â€º should retry on markdown linting failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "Fixed content"
    Received: "Some spec content"

    [0m [90m 207 |[39m
     [90m 208 |[39m       expect(result[33m.[39marchitecture)[33m.[39mtoBe([32m'Fixed content'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 209 |[39m       expect(result[33m.[39mspecifications)[33m.[39mtoBe([32m'Fixed content'[39m)[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 210 |[39m       expect(mockAI[33m.[39mgenerate)[33m.[39mtoHaveBeenCalledTimes([35m3[39m)[33m;[39m [90m// Should retry[39m
     [90m 211 |[39m     })[33m;[39m
     [90m 212 |[39m   })[33m;[39m[0m

      at Object.toBe (src/test/generate-architecture.test.ts:209:37)

  â— generateArchitecture AI Flow â€º markdown parsing â€º should handle fallback parsing when headers are missing

    expect(received).toBeTruthy()

    Received: ""

    [0m [90m 250 |[39m       [90m// Should still return content even with poor formatting[39m
     [90m 251 |[39m       expect(result[33m.[39marchitecture)[33m.[39mtoBeTruthy()[33m;[39m
    [31m[1m>[22m[39m[90m 252 |[39m       expect(result[33m.[39mspecifications)[33m.[39mtoBeTruthy()[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 253 |[39m     })[33m;[39m
     [90m 254 |[39m   })[33m;[39m
     [90m 255 |[39m[0m

      at Object.toBeTruthy (src/test/generate-architecture.test.ts:252:37)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    Detected Libraries:

      at Object.log (src/test/library-identifier-integration.test.ts:145:13)

  console.log
    - react (library) - Confidence: 0.90 - Tasks: task-1, task-4

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - typescript (library) - Confidence: 0.90 - Tasks: task-1

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - react-dom (library) - Confidence: 0.90 - Tasks: task-1

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - express (library) - Confidence: 0.90 - Tasks: task-2

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - mongoose (library) - Confidence: 0.90 - Tasks: task-2

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - jest (library) - Confidence: 0.90 - Tasks: task-2

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - docker (library) - Confidence: 0.90 - Tasks: task-3

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - kubernetes (library) - Confidence: 0.90 - Tasks: task-3

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - nginx (library) - Confidence: 0.90 - Tasks: task-3

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - react-native (library) - Confidence: 0.90 - Tasks: task-4

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    - redux-toolkit (library) - Confidence: 0.90 - Tasks: task-4

      at log (src/test/library-identifier-integration.test.ts:147:15)
          at Array.forEach (<anonymous>)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    DEBUG: Integration test using default response

      at Object.log (src/test/library-identifier-integration.test.ts:50:15)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    DEBUG: Integration test - received prompt: You are a software development expert tasked with extracting required libraries, packages, framework

      at Object.log (src/test/library-identifier-integration.test.ts:20:15)

  console.log
    Extracted Libraries:

      at Object.log (src/test/library-identifier-integration.test.ts:227:13)

  console.log
    - nextjs (library) - Confidence: 0.90

      at log (src/test/library-identifier-integration.test.ts:229:15)
          at Array.forEach (<anonymous>)

  console.log
    - express (library) - Confidence: 0.90

      at log (src/test/library-identifier-integration.test.ts:229:15)
          at Array.forEach (<anonymous>)

  console.log
    - jest (library) - Confidence: 0.90

      at log (src/test/library-identifier-integration.test.ts:229:15)
          at Array.forEach (<anonymous>)

  console.log
    - cypress (library) - Confidence: 0.90

      at log (src/test/library-identifier-integration.test.ts:229:15)
          at Array.forEach (<anonymous>)

PASS src/test/library-identifier-integration.test.ts
  LibraryIdentifier Real-World Integration
    âœ“ should extract libraries from realistic project tasks (18 ms)
    âœ“ should handle edge cases and avoid false positives (6 ms)
    âœ“ should properly categorize libraries based on context (4 ms)

PASS src/test/enhanced-library-extraction.test.ts
  Enhanced Library Extraction
    REQUIRED LIBRARIES pattern extraction
      âœ“ should extract libraries from REQUIRED LIBRARIES sections with highest confidence (5 ms)
      âœ“ should handle comma-separated and space-separated library lists (1 ms)
      âœ“ should extract all valid library names from REQUIRED LIBRARIES (1 ms)
    Combined extraction patterns
      âœ“ should prioritize REQUIRED LIBRARIES over other patterns (1 ms)
    Real-world task scenarios
      âœ“ should extract comprehensive library list from realistic tasks (5 ms)
      âœ“ should filter out invalid patterns that caused DNS errors (1 ms)

  console.log
    âœ… Context structure validation passed

      at Object.log (src/test/basic-validation.test.ts:81:13)

  console.log
    âœ… Task dependency validation passed

      at Object.log (src/test/basic-validation.test.ts:110:13)

  console.log
    âœ… Validation pipeline execution passed

      at Object.log (src/test/basic-validation.test.ts:131:13)

  console.log
    âœ… Architecture-file structure alignment passed

      at Object.log (src/test/basic-validation.test.ts:146:13)

  console.log
    âœ… Task ordering logic passed

      at Object.log (src/test/basic-validation.test.ts:164:13)

  console.log
    âœ… Circular dependency detection passed

      at Object.log (src/test/basic-validation.test.ts:207:13)

  console.log
    âœ… Performance benchmark passed: 0.00ms average

      at Object.log (src/test/basic-validation.test.ts:224:13)

  console.log
    âœ… All architectural flaws have been addressed

      at Object.log (src/test/basic-validation.test.ts:271:13)

  console.log
    âœ… Task enhancement structure validated

      at Object.log (src/test/basic-validation.test.ts:283:13)

PASS src/test/basic-validation.test.ts
  System Validation Tests
    âœ“ Context structure validation (4 ms)
    âœ“ Task dependency validation (2 ms)
    âœ“ Validation pipeline execution (3 ms)
    âœ“ Architecture-file structure alignment (1 ms)
    âœ“ Task ordering logic (2 ms)
    âœ“ Circular dependency detection (1 ms)
    âœ“ Performance benchmarking (2 ms)
  System Architecture Requirements
    âœ“ Addresses identified architectural flaws (5 ms)
    âœ“ Task enhancement structure (2 ms)

PASS src/test/library-identifier.test.ts
  LibraryIdentifier
    identifyLibraries
      âœ“ should extract libraries from import statements (4 ms)
      âœ“ should extract libraries from package manager commands (1 ms)
      âœ“ should extract well-known libraries from context (1 ms)
      âœ“ should filter out invalid library names
      âœ“ should assign correct categories (2 ms)
      âœ“ should handle empty tasks gracefully (1 ms)
      âœ“ should handle tasks with no libraries (1 ms)
      âœ“ should filter libraries by confidence score (1 ms)
      âœ“ should limit number of results (1 ms)

PASS src/test/context-validator.test.ts
  ContextValidator
    validateFullContext
      âœ“ should validate a complete and valid context (3 ms)
      âœ“ should detect missing architecture
      âœ“ should detect missing file structure (1 ms)
      âœ“ should validate task dependencies (1 ms)
      âœ“ should detect circular dependencies
      âœ“ should validate architecture and file structure alignment (1 ms)
      âœ“ should handle empty tasks array
      âœ“ should validate task structure completeness
    error severity handling
      âœ“ should classify errors by severity (1 ms)

PASS src/test/complete-format-fix.test.ts
  Complete Task Format Fix Integration
    âœ“ Task export should produce clean GitHub-ready markdown (3 ms)
    âœ“ All document types should format consistently (2 ms)
    âœ“ Library extraction format should be clean and consistent (1 ms)
    âœ“ Export format should be ready for GitHub issues (1 ms)

PASS src/test/extract-libraries.test.ts
  extractLibraries AI Flow
    basic extraction
      âœ“ should extract libraries from task details (3 ms)
      âœ“ should handle empty task details
      âœ“ should extract from npm install commands (1 ms)
      âœ“ should normalize library names correctly
    error handling
      âœ“ should throw error when model is not provided (8 ms)
      âœ“ should handle API errors gracefully (1 ms)
      âœ“ should handle unexpected response format
    library name validation
      âœ“ should filter out invalid library names
      âœ“ should handle normalized library names (1 ms)
    output parsing
      âœ“ should parse newline-separated output (1 ms)
      âœ“ should remove duplicates from output (2 ms)
      âœ“ should filter out comments and empty lines

  console.log
    Extracted libraries: [
      'react',        'vue',     'angular',
      'typescript',   'express', 'django',
      'flask',        'mongodb', 'postgresql',
      'redis',        'jest',    'cypress',
      'mocha',        'webpack', 'pygame',
      'lodash',       'nextjs',  'react-dom',
      'react-router', 'create',  'components',
      'using',        'hooks',   'setup',
      'routing',      'with',    'extract',
      'the',          'library', 'names',
      'now'
    ]

      at Object.log (src/test/library-validation.test.ts:54:13)

  console.log
    Library details: [
      {
        name: 'react',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'vue',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'angular',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'typescript',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'express',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'django',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'flask',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'mongodb',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'postgresql',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'redis',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'jest',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'cypress',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'mocha',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'webpack',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'pygame',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'lodash',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'nextjs',
        confidence: 0.9,
        context: 'Extracted from task: Game Development with Pygame'
      },
      {
        name: 'react-dom',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'react-router',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'create',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'components',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'using',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'hooks',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'setup',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'routing',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'with',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'extract',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'the',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'library',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'names',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      },
      {
        name: 'now',
        confidence: 0.9,
        context: 'Extracted from task: React Web App'
      }
    ]

      at Object.log (src/test/library-validation.test.ts:55:13)

  console.log
    Categories: { library: 5 }

      at Object.log (src/test/library-validation.test.ts:150:13)

PASS src/test/library-validation.test.ts
  Library Extraction - Core Functionality
    âœ“ should extract real libraries and reject garbage patterns (19 ms)
    âœ“ should handle import statements correctly (2 ms)
    âœ“ should handle package manager commands (1 ms)
    âœ“ should categorize libraries correctly (2 ms)
    âœ“ should filter libraries by confidence and count

PASS src/test/integration.test.ts
  Integration Tests - Real Functionality
    Library Extraction
      âœ“ should extract only real library names from realistic project tasks (11 ms)
      âœ“ should not extract invalid names from complex technical content (1 ms)
      âœ“ should categorize libraries correctly (2 ms)
    Documentation Fetching
      âœ“ should verify library existence before fetching documentation (249 ms)

PASS src/test/browser-markdown-linter-comprehensive.test.ts
  BrowserMarkdownLinter
    lintAndFix
      âœ“ should fix basic formatting issues (3 ms)
      âœ“ should return valid for well-formatted markdown (1 ms)
      âœ“ should handle code blocks correctly (1 ms)
      âœ“ should handle empty input (2 ms)
      âœ“ should handle whitespace-only input
    validateMarkdown
      âœ“ should identify markdown issues
    applyAllFixes
      âœ“ should apply fixes and track changes
    edge cases
      âœ“ should handle very long content (1 ms)
      âœ“ should handle special characters in headers (1 ms)
      âœ“ should preserve inline code (1 ms)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/documentation-fetcher.test.ts:25:15)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/documentation-fetcher.test.ts:31:15)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/documentation-fetcher.test.ts:92:15)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/documentation-fetcher.test.ts:100:15)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/documentation-fetcher.test.ts:106:15)

PASS src/test/documentation-fetcher.test.ts
  DocumentationFetcher
    Library Search and Verification
      âœ“ should verify libraries exist before fetching documentation (3 ms)
      âœ“ should handle invalid library names gracefully (2 ms)
    Documentation Size Management
      âœ“ should respect size limits (1 ms)
    Settings Handling
      âœ“ should return empty result when documentation is disabled (2322 ms)
      âœ“ should handle different source configurations (1 ms)
    Error Handling
      âœ“ should handle network errors gracefully (1 ms)
      âœ“ should continue processing other libraries when one fails (2 ms)
    Web Technology Detection
      âœ“ should identify web technologies for MDN (1 ms)

PASS src/test/research-task-format.test.ts
  Research Task Output
    âœ“ ResearchTaskOutput should have markdownContent field (2 ms)
    âœ“ ResearchTaskOutput format should be GitHub issue ready (1 ms)

PASS src/test/markdown-formatting.test.ts
  Markdown Formatting
    âœ“ formatTaskMarkdown should handle proper markdown (3 ms)
    âœ“ ensureMarkdownStructure should add title if missing (1 ms)
    âœ“ ensureMarkdownStructure should fix header spacing
    âœ“ ensureMarkdownStructure should remove excessive blank lines (1 ms)
    âœ“ ensureMarkdownStructure should end with single newline (1 ms)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:30:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:36:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:42:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:48:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:54:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:60:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:66:13)

  console.log
    âœ… Test skipped - no mocks allowed

      at Object.log (src/test/comprehensive-system.test.ts:74:13)

PASS src/test/comprehensive-system.test.ts
  Comprehensive System Integration Test
    âœ“ Complete project generation workflow (3 ms)
    âœ“ Dependency graph validation (2 ms)
    âœ“ Validation pipeline (1 ms)
    âœ“ Iterative refinement (1 ms)
    âœ“ Input validation (1 ms)
    âœ“ Minimal valid input (1 ms)
    âœ“ Performance benchmarking
  System Architecture Validation
    âœ“ Addresses original architectural flaws (1 ms)

PASS src/test/browser-markdown-linter.test.ts
  BrowserMarkdownLinter
    âœ“ should fix basic markdown formatting issues (2 ms)
    âœ“ should validate already well-formatted markdown
    âœ“ should handle code blocks properly
    âœ“ should fix list formatting (1 ms)

Summary of all failing tests
FAIL src/test/documentation-fetcher-comprehensive.test.ts
  â— DocumentationFetcher Service â€º fetchLibraryDocumentation â€º should fetch documentation for valid libraries

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

    [0m [90m 145 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 146 |[39m
    [31m[1m>[22m[39m[90m 147 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 148 |[39m       expect(result[33m.[39mlibraries[[35m0[39m][33m.[39mname)[33m.[39mtoBe([32m'react'[39m)[33m;[39m
     [90m 149 |[39m       expect(result[33m.[39mfetchedCount)[33m.[39mtoBe([35m1[39m)[33m;[39m
     [90m 150 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBe([35m50[39m)[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:147:32)

  â— DocumentationFetcher Service â€º fetchLibraryDocumentation â€º should trim documentation if it exceeds size limits

    expect(received).toHaveLength(expected)

    Expected length: 1
    Received length: 0
    Received array:  []

    [0m [90m 253 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 254 |[39m
    [31m[1m>[22m[39m[90m 255 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m1[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 256 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBeLessThan([35m2000[39m)[33m;[39m
     [90m 257 |[39m     })[33m;[39m
     [90m 258 |[39m   })[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:255:32)

  â— DocumentationFetcher Service â€º error handling and edge cases â€º should handle concurrent library fetching

    expect(received).toHaveLength(expected)

    Expected length: 2
    Received length: 0
    Received array:  []

    [0m [90m 352 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m documentationFetcher[33m.[39mfetchLibraryDocumentation(libraries)[33m;[39m
     [90m 353 |[39m
    [31m[1m>[22m[39m[90m 354 |[39m       expect(result[33m.[39mlibraries)[33m.[39mtoHaveLength([35m2[39m)[33m;[39m
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 355 |[39m       expect(result[33m.[39mfetchedCount)[33m.[39mtoBe([35m2[39m)[33m;[39m
     [90m 356 |[39m       expect(result[33m.[39mtotalSizeKB)[33m.[39mtoBe([35m30[39m)[33m;[39m
     [90m 357 |[39m     })[33m;[39m[0m

      at Object.toHaveLength (src/test/documentation-fetcher-comprehensive.test.ts:354:32)

FAIL src/test/research-task.test.ts (68.533 s)
  â— researchTask AI Flow â€º basic functionality â€º should research task details and return enhanced task information

    expect(received).toContain(expected) // indexOf

    Expected substring: "Implementation Steps"
    Received string:    "Default research content"

    [0m [90m 79 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m researchTask(input[33m,[39m params[33m.[39mapiKey[33m,[39m params[33m.[39mmodel[33m,[39m params[33m.[39mapiBase)[33m;[39m
     [90m 80 |[39m
    [31m[1m>[22m[39m[90m 81 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Implementation Steps'[39m)[33m;[39m
     [90m    |[39m                                      [31m[1m^[22m[39m
     [90m 82 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Required Libraries'[39m)[33m;[39m
     [90m 83 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'Acceptance Criteria'[39m)[33m;[39m
     [90m 84 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoContain([32m'jsonwebtoken'[39m)[33m;[39m[0m

      at Object.toContain (src/test/research-task.test.ts:81:38)

  â— researchTask AI Flow â€º error handling â€º should handle malformed response gracefully

    expect(received).toBe(expected) // Object.is equality

    Expected: "Invalid response format without proper structure"
    Received: "Task research content"

    [0m [90m 192 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m researchTask(input[33m,[39m params[33m.[39mapiKey[33m,[39m params[33m.[39mmodel[33m,[39m params[33m.[39mapiBase)[33m;[39m
     [90m 193 |[39m
    [31m[1m>[22m[39m[90m 194 |[39m       expect(result[33m.[39mmarkdownContent)[33m.[39mtoBe([32m'Invalid response format without proper structure'[39m)[33m;[39m
     [90m     |[39m                                      [31m[1m^[22m[39m
     [90m 195 |[39m     })[33m;[39m
     [90m 196 |[39m   })[33m;[39m
     [90m 197 |[39m[0m

      at Object.toBe (src/test/research-task.test.ts:194:38)

  â— researchTask AI Flow â€º configuration options â€º should pass configuration options to AI service

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: {"config": {"apiBase": "https://api.test.com", "apiKey": "test-key", "temperature": 0.8}, "model": "test/model", "prompt": StringContaining "Test task"}
    Received
           1
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },
           2
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },
           3
              Object {
                "config": Object {
                  "apiBase": "https://api.test.com",
                  "apiKey": "test-key",
            -     "temperature": 0.8,
                },
                "model": "test/model",
            -   "prompt": StringContaining "Test task",
            +   "prompt": "You are an expert project manager and senior software engineer. Your task is to perform detailed research for a specific development task and provide a comprehensive implementation plan in markdown format following Test-Driven Development (TDD) methodology.
            +
            + **CRITICAL: You MUST output ONLY valid markdown format. DO NOT output JSON format. Use proper headers, lists, code blocks, and formatting. The content will be automatically validated and you may be asked to retry if the markdown is invalid.**
            +
            + The markdown content must follow this exact structure:
            +
            + # {Task Title}
            +
            + ## Context
            +
            + {Briefly explain how this task fits into the overall architecture}
            +
            + ## Implementation Steps (TDD Approach)
            +
            + {Provide a detailed, step-by-step implementation guide following Red-Green-Refactor methodology. Describe what needs to be implemented without including actual code snippets. Focus on:
            + - Files that need to be created or modified
            + - Functions/components that need to be implemented
            + - Integration points with other system components
            + - The expected behavior and functionality
            + - Any specific considerations or edge cases
            + - Test-Driven Development phases (Red-Green-Refactor)}
            +
            + ## Required Libraries
            +
            + {List all libraries, packages, frameworks, and tools needed for this specific task as a comma-separated list. Be comprehensive and specific. Examples:
            + - react, typescript, @types/node, tailwindcss, react-router-dom
            + - express, mongodb, mongoose, bcryptjs, jsonwebtoken, cors
            + - jest, @testing-library/react, @testing-library/jest-dom, @testing-library/user-event}
            +
            + ## Documentation
            +
            + Refer to the reference documentation for the required libraries listed above to understand their APIs, best practices, and implementation details before beginning development.
            +
            + ## Acceptance Criteria
            +
            + {Define what it means for this task to be considered \"done\" as a bulleted list}
            +
            + Overall Project Architecture:
            + Test architecture
            +
            + File Structure:
            + Test structure
            +
            + Overall Project Specifications:
            + Test specifications
            +
            + Now, provide the detailed implementation plan in markdown format for the following task:
            +
            + **Task Title: Test task**
            +
            + **IMPORTANT: Output ONLY markdown content. DO NOT output JSON format. Do not wrap your response in JSON objects or use any JSON structure.**
            + ",
              },

    Number of calls: 3

    [0m [90m 216 |[39m       [36mawait[39m researchTask(input[33m,[39m apiKey[33m,[39m model[33m,[39m apiBase[33m,[39m temperature)[33m;[39m
     [90m 217 |[39m
    [31m[1m>[22m[39m[90m 218 |[39m       expect(mockAI[33m.[39mgenerate)[33m.[39mtoHaveBeenCalledWith({
     [90m     |[39m                               [31m[1m^[22m[39m
     [90m 219 |[39m         model[33m:[39m [32m'test/model'[39m[33m,[39m
     [90m 220 |[39m         prompt[33m:[39m expect[33m.[39mstringContaining([32m'Test task'[39m)[33m,[39m
     [90m 221 |[39m         config[33m:[39m {[0m

      at Object.toHaveBeenCalledWith (src/test/research-task.test.ts:218:31)

FAIL src/test/actions.test.ts (30.217 s)
  â— App Actions â€º runGenerateArchitecture â€º should handle errors from generateArchitecture

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate architecture. The model may have returned an unexpected response."
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:84:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:84:60)

  â— App Actions â€º runGenerateArchitecture â€º should preserve original error if it contains specific messages

    expect(received).rejects.toThrow(expected)

    Expected substring: "Model is required"
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:95:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:95:60)

  â— App Actions â€º runGenerateFileStructure â€º should handle API key errors with specific message

    expect(received).rejects.toThrow(expected)

    Expected substring: "Failed to generate file structure: Your LLM API key is missing or invalid. Please check it in settings."
    Received message:   "File structure generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD, architecture, or specifications."

        [0m [90m 108 |[39m       )[33m;[39m
         [90m 109 |[39m     }
        [31m[1m>[22m[39m[90m 110 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m     |[39m           [31m[1m^[22m[39m
         [90m 111 |[39m       [32m'File structure generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD, architecture, or specifications.'[39m
         [90m 112 |[39m     )[33m;[39m
         [90m 113 |[39m   }[0m

      at runGenerateFileStructure (src/app/actions.ts:110:11)
      at Object.<anonymous> (src/test/actions.test.ts:215:7)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:215:61)

  â— App Actions â€º runResearchTask â€º should call researchTask with correct parameters

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"architecture": "React with JWT", "fileStructure": "src/auth/", "specifications": "Login and registration", "title": "Implement user authentication"},
      "test-key",
      "test/model",
      "https://api.test.com",
    - 0.8,
    + undefined,
    + 0.8,

    Number of calls: 1

    [0m [90m 256 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m runResearchTask(input[33m,[39m options)[33m;[39m
     [90m 257 |[39m
    [31m[1m>[22m[39m[90m 258 |[39m       expect(mockResearchTask)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 259 |[39m         input[33m,[39m
     [90m 260 |[39m         [32m'test-key'[39m[33m,[39m
     [90m 261 |[39m         [32m'test/model'[39m[33m,[39m[0m

      at Object.toHaveBeenCalledWith (src/test/actions.test.ts:258:32)

  â— App Actions â€º runResearchTask â€º should handle errors from researchTask

    thrown: "Exceeded timeout of 30000 ms for a test.
    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout."

    [0m [90m 266 |[39m     })[33m;[39m
     [90m 267 |[39m
    [31m[1m>[22m[39m[90m 268 |[39m     it([32m'should handle errors from researchTask'[39m[33m,[39m [36masync[39m () [33m=>[39m {
     [90m     |[39m     [31m[1m^[22m[39m
     [90m 269 |[39m       [36mconst[39m input [33m=[39m {
     [90m 270 |[39m         title[33m:[39m [32m'Test task'[39m[33m,[39m
     [90m 271 |[39m         architecture[33m:[39m [32m'Test architecture'[39m[33m,[39m[0m

      at it (src/test/actions.test.ts:268:5)
      at describe (src/test/actions.test.ts:235:3)
      at Object.describe (src/test/actions.test.ts:23:1)

  â— App Actions â€º runResearchTask â€º should handle undefined options

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    - Expected
    + Received

      {"architecture": "Test architecture", "fileStructure": "Test structure", "specifications": "Test specifications", "title": "Test task"},
      undefined,
      undefined,
      undefined,
      undefined,
    + undefined,

    Number of calls: 1

    [0m [90m 297 |[39m       [36mconst[39m result [33m=[39m [36mawait[39m runResearchTask(input)[33m;[39m
     [90m 298 |[39m
    [31m[1m>[22m[39m[90m 299 |[39m       expect(mockResearchTask)[33m.[39mtoHaveBeenCalledWith(
     [90m     |[39m                                [31m[1m^[22m[39m
     [90m 300 |[39m         input[33m,[39m
     [90m 301 |[39m         undefined[33m,[39m
     [90m 302 |[39m         undefined[33m,[39m[0m

      at Object.toHaveBeenCalledWith (src/test/actions.test.ts:299:32)

  â— App Actions â€º error handling patterns â€º should preserve specific error messages

    expect(received).rejects.toThrow(expected)

    Expected substring: "Model is required"
    Received message:   "Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD."

        [0m [90m 46 |[39m       )[33m;[39m
         [90m 47 |[39m     }
        [31m[1m>[22m[39m[90m 48 |[39m     [36mthrow[39m [36mnew[39m [33mError[39m(
         [90m    |[39m           [31m[1m^[22m[39m
         [90m 49 |[39m       [32m'Architecture generation failed. The model may have returned an unexpected response. Try a different model or adjust the PRD.'[39m
         [90m 50 |[39m     )[33m;[39m
         [90m 51 |[39m   }[0m

      at runGenerateArchitecture (src/app/actions.ts:48:11)
      at Object.<anonymous> (src/test/actions.test.ts:321:9)
      at Object.toThrow (node_modules/expect/build/index.js:2155:20)
      at Object.toThrow (src/test/actions.test.ts:322:20)

FAIL src/test/generate-architecture.test.ts
  â— generateArchitecture AI Flow â€º error handling â€º should retry on markdown linting failures

    expect(received).toBe(expected) // Object.is equality

    Expected: "Fixed content"
    Received: "Some spec content"

    [0m [90m 207 |[39m
     [90m 208 |[39m       expect(result[33m.[39marchitecture)[33m.[39mtoBe([32m'Fixed content'[39m)[33m;[39m
    [31m[1m>[22m[39m[90m 209 |[39m       expect(result[33m.[39mspecifications)[33m.[39mtoBe([32m'Fixed content'[39m)[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 210 |[39m       expect(mockAI[33m.[39mgenerate)[33m.[39mtoHaveBeenCalledTimes([35m3[39m)[33m;[39m [90m// Should retry[39m
     [90m 211 |[39m     })[33m;[39m
     [90m 212 |[39m   })[33m;[39m[0m

      at Object.toBe (src/test/generate-architecture.test.ts:209:37)

  â— generateArchitecture AI Flow â€º markdown parsing â€º should handle fallback parsing when headers are missing

    expect(received).toBeTruthy()

    Received: ""

    [0m [90m 250 |[39m       [90m// Should still return content even with poor formatting[39m
     [90m 251 |[39m       expect(result[33m.[39marchitecture)[33m.[39mtoBeTruthy()[33m;[39m
    [31m[1m>[22m[39m[90m 252 |[39m       expect(result[33m.[39mspecifications)[33m.[39mtoBeTruthy()[33m;[39m
     [90m     |[39m                                     [31m[1m^[22m[39m
     [90m 253 |[39m     })[33m;[39m
     [90m 254 |[39m   })[33m;[39m
     [90m 255 |[39m[0m

      at Object.toBeTruthy (src/test/generate-architecture.test.ts:252:37)


Test Suites: 4 failed, 6 skipped, 18 passed, 22 of 28 total
Tests:       15 failed, 117 skipped, 196 passed, 328 total
Snapshots:   0 total
Time:        103.935 s
Ran all test suites.
